<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beebee Optimized Renderer</title>
    <script src="https://cdn.jsdelivr.net/gh/jnordberg/gif.js/dist/gif.js"></script>
    <style>
        :root { --bg: #1a1a1a; --panel: #222; --accent: #e74c3c; --btn: #3d3d3d; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        .app-layout { display: flex; flex-direction: column; gap: 15px; background: var(--panel); padding: 20px; border-radius: 12px; width: 95%; max-width: 1100px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .canvas-wrap { flex: 1.5; position: relative; background: #000; border-radius: 8px; overflow: hidden; display: flex; justify-content: center; }
        canvas { max-width: 100%; height: auto; image-rendering: pixelated; }
        .controls { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; max-height: 80vh; padding-right: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        select, button { padding: 12px; background: var(--btn); color: white; border: 1px solid #444; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s; }
        button:hover { background: #4d4d4d; }
        button.active { background: var(--accent); border-color: #ff6b6b; }
        .download-btn { background: #27ae60; border: none; font-weight: bold; }
        .random-btn { background: #f39c12; color: #000; font-weight: bold; }
        label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: -5px; }
        #status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; display: none; z-index: 10; color: #f1c40f; }
        @media (min-width: 900px) { .app-layout { flex-direction: row; } }
    </style>
</head>
<body>

    <div class="app-layout">
        <div class="canvas-wrap">
            <div id="status">PROCESSING GIF...</div>
            <canvas id="c" width="720" height="500"></canvas>
        </div>
        
        <div class="controls">
            <label>Version</label>
            <select id="act"></select>

            <div class="grid">
                <button id="rand" class="random-btn">Randomize</button>
                <button id="vibe">Vibe: OFF</button>
                <button id="flip">Flip: OFF</button>
                <button id="cone">Cone: OFF</button>
            </div>

            <hr style="border:0; border-top:1px solid #333; width:100%">

            <label>Special Pose (*)</label>
            <select id="spec"></select>

            <div class="grid">
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <label>Body</label>
                    <select id="body"></select>
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <label>Eyes</label>
                    <select id="eyes"></select>
                </div>
            </div>
            
            <label>Mouth</label>
            <select id="mouth"></select>

            <button id="loop" style="display:none">Loop Animation</button>
            <button id="dl" class="download-btn">Download PNG</button>
        </div>
    </div>

<script>
const DATA = {
    act1: { src: 'act1_beebee.png', grid: 4, anchor: [273, 200], dim: [720, 500], frames: ["body_normal","body_fear","body_point_crotch","body_point_heart","body_sing","mouth_normal","mouth_normal_talk","mouth_small","mouth_small_talk","mouth_small_lock","eyes_normal","eyes_normal_right","eyes_uncertain","eyes_uncertain_right","eyes_narrow","eyes_narrow_eyebrow","eyes_fear","eyes_pretty","eyes_wat","eyes_wat_2","body_panic*","body_panic_2*","body_scream_anger*","body_scream_anger_2*","body_scream*","body_scream_2*","body_flail*","body_flail2*","body_flail3*","body_flail4*","mouth_smile","mouth_smile_talk","mouth_smile_lock","eyes_smile","eyes_look","eyes_look_sad","eyes_look_sad_smile","eyes_pained1","eyes_pained2","mouth_shut","eyes_anger","body_meta*","body_laugh*","body_pride_talk*","body_pride*","body_squeeze_talk*","body_squeeze*"], loops: { "panic*": [0.07, ["body_panic*", "body_panic_2*"]], "scream*": [0.1, ["body_scream*", "body_scream_2*"]] } },
    act2: { src: 'battle_bb.png', grid: 10, anchor: [292.5, 249.4], dim: [720, 500], frames: ["body_normal","body_two_up","body_chest","body_point","body_one_up","body_scream_a_1*","body_scream_a_2*","body_shocked*","mouth_small","mouth_small_talk","mouth_normal","mouth_normal_talk","mouth_smile","mouth_smile_talk","eyes_normal","eyes_normal_r","eyes_suspect","eyes_suspect_r","eyes_sad","eyes_sad_r","eyes_shock","eyes_happy","eyes_happy_r","eyes_closed","eyes_judge","body_judge_1","body_judge_2","body_scream_b_1*","body_scream_b_2*","body_scream_c_1*","body_scream_c_2*","body_cry_1*","body_cry_2*","body_cry_3*","body_cry_4","mouth_cry_talk","mouth_cry","eyes_cry","eyes_cry_2","body_cry_5*","body_cry_6","mouth_right","mouth_right_talk","eyes_cry_r_1","eyes_cry_r_2","eyes_cry_r_3","eyes_cry_r_4","mouth_blank","eyes_blank","eyes_asdf","eyes_angry","eyes_sad_2","eyes_wat","body_attacked*","body_frazzled","mouth_frazzled_talk","mouth_frazzled","eyes_frazzled","body_panicked","mouth_panicked","mouth_panicked_talk","eyes_panicked","body_special_a*","body_special_b_1*","body_special_b_2*","body_special_b_3*","body_special_c*","body_final_1*","body_final_2*","body_final_3*","body_final_4*","body_yell_1*","body_yell_2*","body_yell_angry_1*","body_yell_angry_2*"], loops: { "final*": [0.05, ["body_final_1*", "body_final_2*", "body_final_3*", "body_final_4*"]] } },
    act3: { src: 'fight_bb.png', grid: 8, anchor: [270, 223], dim: [720, 500], frames: ["body_normal_1","body_normal_2","body_normal_3","body_normal_4","mouth_sorry","mouth_sorry_talk","eyes_sorry_down","eyes_sorry","eyes_sorry_up","mouth_normal","mouth_normal_talk","eyes_oh_crap","eyes_start","eyes_normal","eyes_angry","eyes_sad","mouth_ignore","mouth_ignore_talk","eyes_ignore","eyes_ignore_oh_crap","body_attacked*","body_dead*","body_special_attack*"], loops: {} },
    act4: { src: 'bb_convo.png', grid: 8, anchor: [171, 242], dim: [500, 500], layers: ["coneb", "body", "mouth", "eyes", "cone"], frames: ["body_normal", "body_chest", "body_two_up", "body_one_up", "body_paw", "cone_normal", "coneb_normal", "mouth_normal", "mouth_normal_talk", "mouth_narrow", "mouth_narrow_talk", "mouth_smile", "mouth_smile_talk", "mouth_scream", "mouth_scream_talk", "cone_scream", "coneb_scream", "eyes_normal", "eyes_normal_r", "eyes_normal_u", "eyes_normal_d", "eyes_look_down", "eyes_scream", "eyes_scream_sad", "eyes_super_sad", "eyes_closed", "eyes_closed_annoyed", "eyes_sexy", "eyes_smile", "eyes_smile_r", "eyes_smile_u", "eyes_smile_d", "eyes_angry", "eyes_angry_r", "eyes_angry_u", "eyes_angry_d", "eyes_surprise", "eyes_surprise_r", "eyes_surprise_u", "eyes_surprise_d", "eyes_annoyed", "eyes_annoyed_r", "eyes_annoyed_u", "eyes_annoyed_d", "eyes_sad", "eyes_sad_r", "eyes_sad_u", "eyes_sad_d", "eyes_suspect", "eyes_suspect_r", "body_karate_1*", "body_karate_2*", "cone_karate", "coneb_karate", "body_yap_1*", "body_yap_2*", "body_yap_3*", "body_yap_4*", "cone_yap_1", "cone_yap_2", "cone_yap_3", "cone_yap_4", "eyes_blank", "mouth_blank", "coneb_blank"], loops: { "yap*": [1/24, ["body_yap_1*", "body_yap_2*", "body_yap_3*", "body_yap_4*"]], "karate*": [0.25, ["body_karate_1*", "body_karate_2*"]] } }
};

const UI = {
    act: document.getElementById('act'),
    spec: document.getElementById('spec'),
    body: document.getElementById('body'),
    eyes: document.getElementById('eyes'),
    mouth: document.getElementById('mouth'),
    vibe: document.getElementById('vibe'),
    flip: document.getElementById('flip'),
    cone: document.getElementById('cone'),
    loop: document.getElementById('loop'),
    dl: document.getElementById('dl'),
    rand: document.getElementById('rand'),
    status: document.getElementById('status'),
    c: document.getElementById('c'),
    ctx: document.getElementById('c').getContext('2d', { alpha: true })
};

let state = { act: 'act1', vibe: false, flip: false, cone: false, looping: false, frameIdx: 0, timer: 0, lastUpdate: 0, images: {} };

// PRELOAD ASSETS
Object.keys(DATA).forEach(key => {
    state.images[key] = new Image();
    state.images[key].src = DATA[key].src;
    const opt = document.createElement('option'); opt.value = key; opt.textContent = key.toUpperCase();
    UI.act.appendChild(opt);
});

function syncUI() {
    const act = DATA[state.act];
    [UI.spec, UI.body, UI.eyes, UI.mouth].forEach(s => s.innerHTML = '');
    
    const none = document.createElement('option'); none.value = 'none'; none.textContent = '-- Manual --';
    UI.spec.appendChild(none);

    act.frames.forEach(f => {
        if(f.includes('blank')) return;
        const o = document.createElement('option'); o.value = o.textContent = f;
        if(f.includes('*')) UI.spec.appendChild(o);
        else if(f.startsWith('body')) UI.body.appendChild(o);
        else if(f.startsWith('eyes')) UI.eyes.appendChild(o);
        else if(f.startsWith('mouth')) UI.mouth.appendChild(o);
    });

    UI.cone.style.display = state.act === 'act4' ? 'block' : 'none';
    refresh();
}

function refresh() {
    const isSpec = UI.spec.value !== 'none';
    UI.body.disabled = isSpec;
    UI.eyes.disabled = isSpec || (state.act === 'act2' && UI.body.value.includes('judge'));
    UI.mouth.disabled = isSpec;

    if(state.act === 'act2' && UI.body.value.includes('judge') && !isSpec) UI.eyes.value = 'eyes_judge';

    const loopData = Object.entries(DATA[state.act].loops).find(([k]) => UI.spec.value.includes(k.replace('*','')));
    state.activeLoop = loopData ? loopData[1] : (state.looping ? true : null);
    UI.loop.style.display = state.activeLoop ? 'block' : 'none';
    
    UI.vibe.className = state.vibe ? 'active' : '';
    UI.flip.className = state.flip ? 'active' : '';
    UI.cone.className = state.cone ? 'active' : '';
    UI.dl.textContent = (state.vibe || state.activeLoop) ? "Download GIF" : "Download PNG";
}

UI.act.onchange = (e) => { state.act = e.target.value; syncUI(); };
UI.spec.onchange = UI.body.onchange = refresh;
UI.vibe.onclick = () => { state.vibe = !state.vibe; refresh(); };
UI.flip.onclick = () => { state.flip = !state.flip; refresh(); };
UI.cone.onclick = () => { state.cone = !state.cone; refresh(); };
UI.loop.onclick = () => { state.looping = !state.looping; UI.loop.classList.toggle('active', state.looping); refresh(); };
UI.rand.onclick = () => {
    UI.spec.value = 'none';
    [UI.body, UI.eyes, UI.mouth].forEach(s => s.selectedIndex = Math.floor(Math.random() * s.options.length));
    if(state.act === 'act4') state.cone = Math.random() > 0.5;
    refresh();
};

function drawFrame(name) {
    const d = DATA[state.act];
    const i = d.frames.indexOf(name);
    if(i === -1) return;
    UI.ctx.drawImage(state.images[state.act], (i % d.grid) * d.dim[0], Math.floor(i / d.grid) * d.dim[1], d.dim[0], d.dim[1], -d.anchor[0], -d.anchor[1], d.dim[0], d.dim[1]);
}

function render(t) {
    const dt = (t - state.lastUpdate) / 1000; state.lastUpdate = t;
    UI.ctx.clearRect(0, 0, UI.c.width, UI.c.height);
    UI.ctx.save();
    UI.ctx.translate(UI.c.width / 2, UI.c.height / 2);
    if(state.flip) UI.ctx.scale(-1, 1);
    if(state.vibe) UI.ctx.scale(1, 1 + Math.sin(t * 0.04) * 0.01);

    let main = UI.spec.value !== 'none' ? UI.spec.value : null;
    
    if(Array.isArray(state.activeLoop)) {
        state.timer += dt;
        if(state.timer >= state.activeLoop[0]) { state.frameIdx = (state.frameIdx + 1) % state.activeLoop[1].length; state.timer = 0; }
        main = state.activeLoop[1][state.frameIdx];
    }

    const layers = DATA[state.act].layers || ["body", "mouth", "eyes"];
    layers.forEach(l => {
        if(l.startsWith('cone')) {
            if(!state.cone) return;
            let type = "normal";
            const pose = main || UI.body.value;
            if(pose.includes('yap')) type = "yap_" + (state.frameIdx + 1);
            else if(pose.includes('karate')) type = "karate";
            else if(pose.includes('scream')) type = "scream";
            drawFrame(l + "_" + (l === "coneb" && (type === "normal" || type.startsWith('yap')) ? "blank" : type));
        } else if(l === 'body') drawFrame(main || UI.body.value);
        else if(l === 'mouth') drawFrame(main ? "mouth_blank" : UI.mouth.value);
        else if(l === 'eyes') drawFrame(main ? "eyes_blank" : UI.eyes.value);
    });

    UI.ctx.restore();
    requestAnimationFrame(render);
}

UI.dl.onclick = async () => {
    if(UI.dl.textContent.includes("PNG")) {
        const a = document.createElement('a'); a.download = 'bb.png'; a.href = UI.c.toDataURL(); a.click();
    } else {
        UI.status.style.display = 'block';
        const gif = new GIF({ workers: 2, quality: 10, width: 720, height: 500, workerScript: 'https://cdn.jsdelivr.net/gh/jnordberg/gif.js/dist/gif.worker.js' });
        for(let i=0; i<20; i++) { gif.addFrame(UI.ctx, {copy: true, delay: 50}); await new Promise(r => setTimeout(r, 50)); }
        gif.on('finished', b => { UI.status.style.display = 'none'; const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'bb.gif'; a.click(); });
        gif.render();
    }
};

syncUI();
requestAnimationFrame(render);
</script>
</body>
</html>
